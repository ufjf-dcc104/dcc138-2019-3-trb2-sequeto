<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <title>Game</title>
</head>
<body>
    <canvas/>

    <script>
        // Variáveis
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("personagem", "Assets/personagem.png")
        assetsMng.loadImage("orc", "Assets/orc.png")

        var canvas = document.querySelector("canvas");
        canvas.width = 600;
        canvas.height = 400;
        var ctx = canvas.getContext("2d");
        var dt, anterior = 0;
        var controle = { esquerda: 0, cima: 0, direita: 0, baixo: 0, espaco: 0};

        var cena = new Scene({w:canvas.widht, h:canvas.height, ctx:ctx, assets: assetsMng});
        var personagem = new Sprite({w:20, h:20, x:30, y:canvas.height/2 - 10, vx:10, vy:0, Scene: cena, comportamento: Controlar(controle)});
        var orcs = new Sprite({w:20, h:20, x:50, y:canvas.height/5 - 10, vx:10, vy:0, Scene: cena, comportamento: perseguir(personagem) , desenhar:desenhaOrc});
        cena.desenhar();

        cena.adicionar(personagem);
        cena.adicionar(orcs);

        // Controle
        function desenhaOrc(ctx){
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.drawImage(
                this.scene.assets.img("orc"),
                this.frame,
                this.posicao,
                this.size,
                this.size,
                -this.size / 2,
                1 - this.size,
                this.size,
                this.size
            );
            ctx.restore();
        }

        function perseguir(alvo){
            return function () {
                if (this.x === alvo.x) {
                    if (this.y > alvo.y) {
                        this.vy = 10 * Math.sign(alvo.y - this.y);
                        this.posicao = (8 * this.size) + (this.size * 0)
                    }

                    else {
                        this.vy = 10 * Math.sign(alvo.y - this.y);
                        this.posicao = (8 * this.size) + (this.size * 2)
                    }
                }

                if (this.y === alvo.y){
                    if (this.x > alvo.x) {
                        this.vx = 10 * Math.sign(alvo.x - this.x);
                        this.posicao = (8 * this.size) + (this.size * 1)
                    }

                    else {
                        this.vx = 10 * Math.sign(alvo.x - this.x);
                        this.posicao = (8 * this.size) + (this.size * 3)
                    }
                }

                if (this.y > alvo.y) {
                    this.vy = 10 * Math.sign(alvo.y - this.y);
                    this.posicao = (8 * this.size) + (this.size * 0)
                }

                if (this.y < alvo.y) {
                    this.vy = 10 * Math.sign(alvo.y - this.y);
                    this.posicao = (8 * this.size) + (this.size * 2)
                }

                if (this.x > alvo.x) {
                    this.vx = 10 * Math.sign(alvo.x - this.x);
                    this.posicao = (8 * this.size) + (this.size * 1)
                }

                if (this.x < alvo.x) {
                    this.vx = 10 * Math.sign(alvo.x - this.x);
                    this.posicao = (8 * this.size) + (this.size * 3)
                }

                this.animacao++;
                if (this.animacao >= 40){
                    this.animacao = 0 
                };
                this.frame = Math.floor(this.animacao / 5) * this.size
            }
        }
        function Controlar(controle) {
            return function() {
                // Botões Apertados
                if (controle.cima) {
                    this.vy = -50;
                    this.posicao = (8 * this.size) + (this.size * 0)
                }
                else
                if (controle.baixo) {
                    this.vy = 50;
                    this.posicao = (8 * this.size) + (this.size * 2)
                }

                if (controle.esquerda) {
                    this.vx = -50;
                    this.posicao = (8 * this.size) + (this.size * 1)
                }
                if (controle.direita) {
                    this.vx = 50;
                    this.posicao = (8 * this.size) + (this.size * 3)
                }

                if (controle.esquerda || controle.direita || controle.cima || controle.baixo) {
                    this.animacao++;
                    if (this.animacao >= 40){
                         this.animacao = 0 
                    };
                    this.frame = Math.floor(this.animacao / 5) * this.size;
                } 
                
                else {
                    this.frame = 0;
                    this.animacao = 0;
                }

                // Botões Soltos
                if (!controle.cima && !controle.baixo) {
                    this.vy = 0;
                }

                if (!controle.esquerda && !controle.direita) {
                    this.vx = 0;
                }
            }
        }

        // Escuta das controle
        addEventListener("keydown", function (e) {
            switch (e.keyCode) {
                case 32:
                    controle.espaco = 1;
                case 38:
                    controle.cima = 1;
                    break;
                case 37:
                    controle.esquerda = 1;
                    break;
                case 39:
                    controle.direita = 1;
                    break;
                case 40:
                    controle.baixo = 1;
                    break;
            }
        });

        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    controle.espaco = 0;
                    break;
                case 38:
                    controle.cima = 0;
                    break;
                case 37:
                    controle.esquerda = 0;
                    break;
                case 39:
                    controle.direita = 0;
                    break;
                case 40:
                    controle.baixo = 0;
                    break;
            }
        });

        // Loop
        function passo(t){
            dt = (t - anterior)/1000;
            if(assetsMng.progresso()===100){
                cena.passo(dt);
            }
            anterior = t;
            requestAnimationFrame(passo);
        }

        requestAnimationFrame(passo);
    </script>
    
</body>
</html>